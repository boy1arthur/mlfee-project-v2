<!DOCTYPE html>
<html lang="ko" class="scroll-smooth">
<head>
    <!-- 1. SEO ë° ê¸°ë³¸ í˜ì´ì§€ ì„¤ì • -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìì¿° íƒ€ì´ë¨¸ | MLFEE</title>
    <meta name="description" content="ìì¿° ì›ì • í•„ìˆ˜ ë„êµ¬! ìì¿° íƒ€ì´ë¨¸ë¡œ ë¹„ìˆì˜ ë¦¬ì €ë ‰ì…˜ ì¿¨íƒ€ì„ì„ ì™„ë²½í•˜ê²Œ ê´€ë¦¬í•˜ê³ , íŒŒí‹°ì›ë“¤ê³¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìƒí™©ì„ ê³µìœ í•˜ì„¸ìš”.">
    <meta name="keywords" content="ë©”ì´í”Œëœë“œ, ë©”ëœ, ë¦¬ì €ë ‰ì…˜, íƒ€ì´ë¨¸, ë¦¬ì €, ìì¿°, í˜¼í…Œì¼, ì›ì •ëŒ€, ë ˆì´ë“œ, ë¹„ìˆ, MLFEE, ë©”í”¼">
    <meta property="og:title" content="ìì¿° íƒ€ì´ë¨¸ - ë©”ì´í”Œëœë“œ í•„ìˆ˜ ë ˆì´ë“œ íƒ€ì´ë¨¸">
    <meta property="og:description" content="ì‹¤ì‹œê°„ ë™ê¸°í™”ì™€ ì§€ëŠ¥í˜• ì‹œê°„ ì•ˆë‚´ë¡œ ë ˆì´ë“œì˜ ì•ˆì •ì„±ì„ ë†’ì—¬ë³´ì„¸ìš”.">
    <meta property="og:image" content="https://raw.githubusercontent.com/boy1arthur/mlfee-project/main/images/mlfee-logo.png">
    <link rel="icon" href="https://raw.githubusercontent.com/boy1arthur/mlfee-project/main/images/mlfee-logo.png" type="image/png">

    <!-- 2. ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° í°íŠ¸ -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8602495420447615" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- 3. í…Œë§ˆ ë° ìŠ¤íƒ€ì¼ -->
    <style>
        :root, .theme-zakum { 
            --base-bg: #1a110a; 
            --card-bg: #2d1d11; 
            --input-bg: #422c1a; 
            --border-color: #5c3d25; 
            --text-primary: #fde8d7; 
            --text-secondary: #c4a78e;
            --accent-color: #ff6600; 
        }
        .theme-hontale { 
            --base-bg: #121212; --card-bg: #1e1e1e; --input-bg: #2a2a2a; --border-color: #444; 
            --text-primary: #e0e0e0; --text-secondary: #9e9e9e; --accent-color: #ffd700; 
        }
        .theme-default {
            --base-bg: #0a0e1a; --card-bg: #1e293b; --input-bg: #2d3748; --border-color: #334155;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8; --accent-color: #22D3EE;
        }
        
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--base-bg); color: var(--text-primary); }
        
        .main-title { font-size: 2.5rem; font-weight: 900; color: var(--accent-color); text-shadow: 0 0 8px rgba(255, 102, 0, 0.7); }
        .card { background-color: var(--card-bg); border-radius: 0.5rem; border: 1px solid var(--border-color); padding: 1.5rem; }
        .input-field { background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; transition: all 0.2s; }
        .input-field:focus { outline: none; border-color: var(--accent-color); background-color: #333; }
        
        .btn { background-color: var(--input-bg); color: var(--accent-color); font-weight: 600; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; text-align: center; }
        .btn:hover:not(:disabled) { background-color: var(--accent-color); color: var(--base-bg); border-color: var(--accent-color); }
        .btn:disabled { background-color: #2a2a2a; color: #666; border-color: #444; cursor: not-allowed; }
        
        .btn-start { background-color: #059669; border-color: #059669; color: white; }
        .btn-start:hover:not(:disabled) { background-color: #10b981; }
        .btn-death { background-color: #dc2626; border-color: #dc2626; color: white; }
        .btn-death:hover:not(:disabled) { background-color: #ef4444; }
        .btn-res { background-color: #2563eb; border-color: #2563eb; color: white; }
        .btn-res:hover:not(:disabled) { background-color: #3b82f6; }

        .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; padding-bottom: 0.5rem; text-align: center; color: var(--accent-color); border-bottom: 1px solid var(--border-color); }
        
        .summary-container { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .summary-container.expanded { max-height: 2000px; }
    </style>

    <!-- âœ¨ [ì ìš© ì™„ë£Œ] Google Analytics ì¶”ì  ì½”ë“œ -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VLQR1NXFFM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-VLQR1NXFFM');
    </script>
</head>
<body class="theme-zakum" data-tool-id="timer">

<main class="py-8 px-4">
    <div class="w-full max-w-7xl mx-auto space-y-6">
        
        <header class="flex justify-between items-center px-2">
            <a href="https://mlfee.com" class="inline-block">
                <img src="https://raw.githubusercontent.com/boy1arthur/mlfee-project/main/images/mlfee-logo.png" alt="MLFEE ë¡œê³ " class="h-10">
            </a>
            <div class="text-center">
                <h1 class="main-title">ìì¿° íƒ€ì´ë¨¸</h1>
            </div>
            <div class="flex items-center gap-2">
                 <div id="theme-selector" class="relative">
                    <button id="theme-btn" class="btn p-2"><i class="fas fa-palette"></i></button>
                    <div id="theme-dropdown" class="absolute right-0 mt-2 w-48 bg-black border border-gray-700 rounded-lg shadow-lg hidden z-10">
                        <a href="#" class="theme-option block px-4 py-2 text-sm hover:bg-gray-800" data-theme="zakum">ìì¿° (ê¸°ë³¸)</a>
                        <a href="#" class="theme-option block px-4 py-2 text-sm hover:bg-gray-800" data-theme="hontale">í˜¼í…Œì¼</a>
                        <a href="#" class="theme-option block px-4 py-2 text-sm hover:bg-gray-800" data-theme="default">ì–´ë‘ </a>
                    </div>
                </div>
                <button id="muteBtn" class="btn p-2"><i class="fas fa-volume-high"></i></button>
            </div>
        </header>

        <!-- ê²°ê³¼ ìš”ì•½ -->
        <div id="summaryContainer" class="summary-container card">
            <div id="summaryContent" class="text-left space-y-4 text-secondary text-lg"></div>
        </div>
        
        <!-- ë©”ì¸ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ -->
        <div class="grid grid-cols-1 xl:grid-cols-5 gap-6">
            
            <!-- ì¢Œì¸¡ ì»¬ëŸ¼ -->
            <div class="xl:col-span-2 space-y-6">
                <!-- ë©”ì¸ ì»¨íŠ¸ë¡¤ -->
                <div class="card">
                    <h2 class="section-title">ğŸ•¹ï¸ ë©”ì¸ ì»¨íŠ¸ë¡¤</h2>
                    <div class="text-center mb-6">
                        <div id="totalTime">
                            <span class="text-lg font-semibold text-secondary">ë ˆì´ë“œ ê²½ê³¼</span>
                            <p class="text-5xl font-bold tracking-wider font-mono text-primary">00:00</p>
                        </div>
                    </div>
                    <div id="control-panel" class="flex flex-col items-center justify-center min-h-[150px]"></div>
                    <div id="briefing" class="mt-4 text-center text-secondary font-semibold h-6 text-lg"></div>
                     <div class="flex items-center justify-center space-x-3 bg-black/20 p-2 rounded-full mt-4 max-w-xs mx-auto">
                        <span id="manualModeLabel" class="text-sm font-bold px-2 transition-colors">ìˆ˜ë™</span>
                        <label for="autoDeathToggle" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoDeathToggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent-color"></div>
                        </label>
                        <span id="autoModeLabel" class="text-sm font-bold px-2 transition-colors">ìë™</span>
                    </div>
                </div>

                <!-- ì‹œê°„ ì •ë³´ -->
                <div class="card">
                    <h2 class="section-title">ğŸ•’ ì‹œê°„ ì •ë³´</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="text-center">
                            <p class="text-base text-secondary mb-1">í˜„ì¬ ì‹œê° (KST)</p>
                            <p id="kstTime" class="text-4xl font-bold tracking-wider font-mono" style="color: var(--accent-color);">00:00:00</p>
                        </div>
                        <div id="resTimesDisplay" class="text-center cursor-pointer hidden p-2 rounded-lg hover:bg-black/20 transition-colors" title="í´ë¦­í•˜ì—¬ ë¶„ ë‹¨ìœ„ ì‹œê°„ ë³µì‚¬">
                            <p class="text-base text-yellow-400 mb-1">ë¦¬ì € ê¶Œì¥ ì‹œê°</p>
                            <p id="resTimesList" class="text-3xl font-bold tracking-wider font-mono text-yellow-300">-</p>
                        </div>
                    </div>
                    <div id="resGaugeContainer" class="hidden pt-4 mt-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-lg text-emerald-400 font-bold">ë¦¬ì €ë ‰ì…˜ ìœ íš¨ ì‹œê°„</span>
                            <span id="resurrectionTime" class="text-2xl font-bold tracking-wider text-emerald-400 font-mono">--:--</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                            <div id="resGaugeBar" class="h-4 rounded-full transition-all duration-500 bg-gradient-to-r from-emerald-500 to-teal-600"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìš°ì¸¡ ì»¬ëŸ¼ -->
            <div class="xl:col-span-3 space-y-6">
                <!-- ë¹„ìˆ ê´€ë¦¬ -->
                <div class="card">
                    <div id="bishopSection">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="section-title flex-grow m-0 p-0 border-none text-left text-2xl">ğŸ’– íŒŒí‹°ì› í˜„í™©</h2>
                            <button id="addBishopBtn" class="btn p-2 h-10 w-10 text-xl">+</button>
                        </div>
                        <div class="overflow-x-auto bg-black/20 rounded-lg p-2">
                            <table class="w-full text-left text-lg"><thead class="border-b border-gray-600"><tr class="text-base text-secondary"><th class="p-3">ìˆœë²ˆ</th><th class="p-3">ë¹„ìˆ</th><th class="p-3">ìƒíƒœ</th><th class="p-3">ì¿¨íƒ€ì„</th><th class="p-3">ì‚¬ìš© ì‹œê°</th><th class="p-3"></th></tr></thead><tbody id="bishop-list"></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- ë¡œê·¸ ë° ë©”ëª¨ -->
                <div class="card">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div id="log-section" class="bg-black/20 rounded-lg flex flex-col">
                            <h2 class="p-4 font-bold text-lg text-center border-b border-gray-700 flex-shrink-0">ì´ë²¤íŠ¸ ë¡œê·¸</h2>
                            <div id="eventLog" class="p-3 space-y-2 overflow-y-auto h-48 text-base flex-grow"></div>
                        </div>
                        <div id="notepad-section" class="bg-black/20 rounded-lg flex flex-col">
                            <h2 class="p-4 font-bold text-lg text-center border-b border-gray-700 flex-shrink-0">ë ˆì´ë“œ ë©”ëª¨ì¥</h2>
                            <textarea id="raidNotepad" class="w-full h-48 bg-transparent p-3 text-secondary focus:outline-none resize-none flex-grow" placeholder="íŠ¹ì´ì‚¬í•­ì„ ë©”ëª¨í•˜ì„¸ìš”..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-center gap-4 pt-4">
            <button id="endRaidBtn" class="btn btn-death text-lg hidden">ë ˆì´ë“œ ì¢…ë£Œ</button>
            <button id="resetBtn" class="btn text-lg">ì´ˆê¸°í™”</button>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const RES_DURATION = 15 * 60;
    const BISHOP_COOLDOWN = 30 * 60;
    const IDEAL_CYCLE_TIME = 14 * 60;

    const dom = {
        totalTime: document.getElementById('totalTime').querySelector('p'),
        resTime: document.getElementById('resurrectionTime'),
        controlPanel: document.getElementById('control-panel'),
        bishopSection: document.getElementById('bishopSection'),
        addBishopBtn: document.getElementById('addBishopBtn'),
        bishopList: document.getElementById('bishop-list'),
        resetBtn: document.getElementById('resetBtn'),
        muteBtn: document.getElementById('muteBtn'),
        endRaidBtn: document.getElementById('endRaidBtn'),
        briefing: document.getElementById('briefing'),
        kstTime: document.getElementById('kstTime'),
        resGaugeContainer: document.getElementById('resGaugeContainer'),
        resGaugeBar: document.getElementById('resGaugeBar'),
        eventLog: document.getElementById('eventLog'),
        logSection: document.getElementById('log-section'),
        resTimesDisplay: document.getElementById('resTimesDisplay'),
        resTimesList: document.getElementById('resTimesList'),
        summaryContainer: document.getElementById('summaryContainer'),
        summaryContent: document.getElementById('summaryContent'),
        autoDeathToggle: document.getElementById('autoDeathToggle'),
        autoModeLabel: document.getElementById('autoModeLabel'),
        manualModeLabel: document.getElementById('manualModeLabel'),
        raidNotepad: document.getElementById('raidNotepad'),
        themeBtn: document.getElementById('theme-btn'),
        themeDropdown: document.getElementById('theme-dropdown'),
        themeOptions: document.querySelectorAll('.theme-option'),
    };

    let timerInterval = null, isMuted = false, autoDeathTimeoutId = null;
    let raidState = {};

    // --- ì‚¬ìš´ë“œ ê´€ë¦¬ì ---
    class SoundManager {
        constructor() {
            this.audioCtx = null;
            this.isInitialized = false;
        }

        // ì‚¬ìš©ìì˜ ì²« ìƒí˜¸ì‘ìš© ì‹œ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        async initialize() {
            if (this.isInitialized || (!window.AudioContext && !window.webkitAudioContext)) return;
            try {
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ê°€ 'suspended' ìƒíƒœì¼ ê²½ìš° 'resume' ì‹œë„
                if (this.audioCtx.state === 'suspended') {
                    await this.audioCtx.resume();
                }
                this.isInitialized = true;
            } catch (e) {
                console.error("ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", e);
            }
        }

        // íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ íš¨ê³¼ìŒ ì¬ìƒ
        play(type) {
            if (!this.isInitialized || isMuted) return;

            const oscillator = this.audioCtx.createOscillator();
            const gainNode = this.audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(this.audioCtx.destination);

            gainNode.gain.setValueAtTime(0, this.audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, this.audioCtx.currentTime + 0.01);

            switch (type) {
                case 'start':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, this.audioCtx.currentTime);
                    break;
                case 'death':
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(261.63, this.audioCtx.currentTime);
                    break;
                case 'res-used':
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(523.25, this.audioCtx.currentTime);
                    break;
                default:
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(300, this.audioCtx.currentTime);
            }

            oscillator.start(this.audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, this.audioCtx.currentTime + 0.2);
            oscillator.stop(this.audioCtx.currentTime + 0.2);
        }
    }
    const soundManager = new SoundManager();

    // --- í…Œë§ˆ ê´€ë¦¬ì ---
    class ThemeManager {
        constructor() {
            this.currentTheme = localStorage.getItem('raidChronicleTheme') || 'zakum';
            this._init();
        }
        _init() {
            this.applyTheme(this.currentTheme);
            dom.themeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dom.themeDropdown.classList.toggle('hidden');
            });
            dom.themeOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.applyTheme(e.target.dataset.theme);
                    dom.themeDropdown.classList.add('hidden');
                });
            });
            document.addEventListener('click', (e) => {
                if (!dom.themeBtn.contains(e.target) && !dom.themeDropdown.contains(e.target)) {
                    dom.themeDropdown.classList.add('hidden');
                }
            });
        }
        applyTheme(themeName) {
            document.body.className = `theme-${themeName}`;
            localStorage.setItem('raidChronicleTheme', themeName);
            this.currentTheme = themeName;
        }
    }

    // --- ë©”ëª¨ì¥ ëª¨ë“ˆ ---
    class Notepad {
        constructor(textareaElement) {
            this.textarea = textareaElement;
            this.storageKey = 'raidChronicleNotepad';
            this._init();
        }
        _init() {
            if (!this.textarea) return;
            this.textarea.value = localStorage.getItem(this.storageKey) || '';
            this.textarea.addEventListener('input', () => this._save());
        }
        _save() {
            localStorage.setItem(this.storageKey, this.textarea.value);
        }
    }

    function getInitialState() {
        return {
            state: 'initial', raidStartedAt: null, totalSeconds: 0, resurrectionActiveUntil: null,
            resScheduleTimes: [], currentBishopIndex: 0,
            bishops: [
                { name: 'ë¹„ìˆ1', cooldownEndsAt: null, usedAt: null, resCount: 0 },
                { name: 'ë¹„ìˆ2', cooldownEndsAt: null, usedAt: null, resCount: 0 },
            ],
            logs: [{ timestamp: new Date().toISOString(), message: 'ìì¿° ë¸Œë ˆì´ì»¤ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', type: 'system' }],
            isAutoDeathMode: true,
        };
    }

    function init() {
        raidState = getInitialState();
        const savedMode = localStorage.getItem('raidChronicle_autoDeathMode');
        raidState.isAutoDeathMode = savedMode !== null ? JSON.parse(savedMode) : true;
        dom.autoDeathToggle.checked = raidState.isAutoDeathMode;
        updateAutoDeathModeUI(raidState.isAutoDeathMode);
        render(raidState);
        setInterval(updateKstClock, 1000);
        attachEventListeners();
        new Notepad(dom.raidNotepad);
        new ThemeManager();
        
        // ì‚¬ìš©ìì˜ ì²« ìƒí˜¸ì‘ìš© ì‹œ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ë¥¼ í™œì„±í™”í•˜ê¸° ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const initializeAudio = () => {
            soundManager.initialize();
            document.body.removeEventListener('click', initializeAudio);
            document.body.removeEventListener('keydown', initializeAudio);
        };
        document.body.addEventListener('click', initializeAudio, { once: true });
        document.body.addEventListener('keydown', initializeAudio, { once: true });
    }
    
    function render(data) {
        if (!data) return;
        if (timerInterval) clearInterval(timerInterval);
        if (data.state !== 'ended') {
            timerInterval = setInterval(() => updateTimers(data), 1000);
        }
        updateTimers(data);
        dom.endRaidBtn.classList.toggle('hidden', data.state === 'initial' || data.state === 'ended');
        dom.resGaugeContainer.classList.toggle('hidden', data.state !== 'res-active');
        dom.addBishopBtn.disabled = data.state !== 'initial';
        if (data.state !== 'ended') {
            dom.summaryContainer.classList.remove('expanded');
        }
        renderControlPanel(data);
        renderBishopList(data.bishops, data.currentBishopIndex, data.state);
        renderLogs(data.logs);
    }
    
    function updateTimers(data) {
        updateKstClock();
        if (data.state === 'initial' || data.state === 'ended') {
            dom.totalTime.textContent = formatTime(data.totalSeconds, false);
            dom.resTimesDisplay.classList.add('hidden');
            updateBishopCooldowns(data.bishops, data.currentBishopIndex, data.state);
            return;
        }
        const now = Date.now();
        if (data.raidStartedAt) {
            dom.totalTime.textContent = formatTime(Math.floor((now - data.raidStartedAt) / 1000), false);
        }
        if (data.state === 'res-active' && data.resurrectionActiveUntil) {
            const resSeconds = Math.max(0, Math.floor((data.resurrectionActiveUntil - now) / 1000));
            dom.resTime.textContent = formatTime(resSeconds, false);
            dom.resGaugeBar.style.width = `${(resSeconds / RES_DURATION) * 100}%`;
            const gaugeClasses = dom.resGaugeBar.classList;
            gaugeClasses.remove('from-emerald-500', 'from-yellow-500', 'from-red-500', 'to-teal-600', 'to-orange-500', 'to-red-600');
            if (resSeconds <= 60) gaugeClasses.add('bg-gradient-to-r', 'from-red-500', 'to-red-600');
            else if (resSeconds <= 300) gaugeClasses.add('bg-gradient-to-r', 'from-yellow-500', 'to-orange-500');
            else gaugeClasses.add('bg-gradient-to-r', 'from-emerald-500', 'to-teal-600');
            if (data.resScheduleTimes?.length > 0) {
                const timeStrings = data.resScheduleTimes.map(ts => formatClockTime(new Date(ts)));
                const firstTime = `<span class="text-yellow-300">${timeStrings[0]}</span>`;
                const nextTimes = timeStrings.slice(1).join('<span class="text-gray-500"> / </span>');
                dom.resTimesList.innerHTML = `${firstTime} <span class="text-gray-500">/</span> ${nextTimes}`;
                dom.resTimesDisplay.classList.remove('hidden');
            }
        } else {
            dom.resGaugeContainer.classList.add('hidden');
            dom.resTimesDisplay.classList.add('hidden');
        }
        updateBishopCooldowns(data.bishops, data.currentBishopIndex, data.state);
    }

    function renderControlPanel(data) {
        let buttonHTML = '', briefingText = '';
        const buttonClasses = "btn text-3xl font-bold py-8 px-6 rounded-lg w-full max-w-sm";
        switch (data.state) {
            case 'initial':
                buttonHTML = `<button id="startRaidBtn" class="${buttonClasses} btn-start">ë ˆì´ë“œ ì‹œì‘</button>`;
                briefingText = "íŒŒí‹°ì›ì„ ì„¤ì •í•˜ê³  ë ˆì´ë“œë¥¼ ì‹œì‘í•˜ì„¸ìš”.";
                break;
            case 'running':
                buttonHTML = `<button id="deathBtn" class="${buttonClasses} btn-death">ì‚¬ë§ì ë°œìƒ</button>`;
                briefingText = data.bishops.length > 0 ? `ğŸŸ¢ ë‹¤ìŒ ë¦¬ì €: ${data.bishops[data.currentBishopIndex].name}` : 'ë¹„ìˆì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.';
                break;
            case 'res-active':
                const bishop = data.bishops[data.currentBishopIndex];
                const onCooldown = bishop.cooldownEndsAt && bishop.cooldownEndsAt > Date.now();
                const cooldownSeconds = onCooldown ? Math.floor((bishop.cooldownEndsAt - Date.now()) / 1000) : 0;
                buttonHTML = `<button id="useResBtn" class="${buttonClasses} btn-res" ${onCooldown ? 'disabled' : ''}>${bishop.name} ë¦¬ì € ì‚¬ìš©</button>`;
                briefingText = onCooldown ? `ğŸ”´ ${bishop.name} ì¿¨íƒ€ì„! (${formatTime(cooldownSeconds, false)} ë‚¨ìŒ)` : `ğŸš¨ ${bishop.name}ë‹˜, ë¦¬ì €ë ‰ì…˜ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”!`;
                break;
            case 'ended':
                buttonHTML = `<p class="text-3xl font-bold text-yellow-400">ë ˆì´ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
                briefingText = "ê²°ê³¼ ìš”ì•½ì„ í™•ì¸í•˜ê±°ë‚˜ ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.";
                break;
        }
        dom.controlPanel.innerHTML = buttonHTML;
        dom.briefing.textContent = briefingText;
    }
    
    function renderBishopList(bishops, currentIndex, state) {
        dom.bishopList.innerHTML = '';
        if (!bishops) return;
        bishops.forEach((b, i) => {
            const row = document.createElement('tr');
            row.className = `border-b border-gray-700/50`;
            row.innerHTML = `
                <td class="p-3">${i + 1}</td>
                <td class="p-3 bishop-name cursor-pointer hover:bg-gray-800 rounded-md" contenteditable="${state === 'initial'}" data-index="${i}">${b.name}</td>
                <td class="p-3 font-bold"></td>
                <td class="p-3 font-mono"></td>
                <td class="p-3 font-mono">${b.usedAt ? formatClockTime(new Date(b.usedAt)) : '--:--:--'}</td>
                <td class="p-3 text-center"><button class="remove-bishop-btn text-red-500 hover:text-red-400 font-bold text-2xl ${state !== 'initial' ? 'hidden' : ''}" data-index="${i}">&times;</button></td>
            `;
            dom.bishopList.appendChild(row);
        });
        updateBishopCooldowns(bishops, currentIndex, state);
    }

    function updateBishopCooldowns(bishops, currentIndex, state) {
        if (!bishops) return;
        const rows = dom.bishopList.querySelectorAll('tr');
        if (rows.length !== bishops.length) return;
        bishops.forEach((b, i) => {
            const row = rows[i];
            if (!row) return;
            const now = Date.now();
            const onCooldown = b.cooldownEndsAt && b.cooldownEndsAt > now;
            const cooldownSeconds = onCooldown ? Math.floor((b.cooldownEndsAt - now) / 1000) : 0;
            const statusText = onCooldown ? 'ì¿¨íƒ€ì„' : 'ëŒ€ê¸°';
            const statusClass = onCooldown ? 'text-orange-400' : 'text-green-400';
            const isCurrent = i === currentIndex && (state === 'running' || state === 'res-active');
            row.cells[2].textContent = statusText;
            row.cells[2].className = `p-3 font-bold ${statusClass}`;
            row.cells[3].textContent = onCooldown ? formatTime(cooldownSeconds, false) : 'ì‚¬ìš© ê°€ëŠ¥';
            row.classList.toggle('bg-yellow-400/10', isCurrent);
        });
    }
    
    function renderLogs(logs) {
        dom.eventLog.innerHTML = '';
        if (!logs) return;
        logs.slice(-20).forEach(log => {
            const colors = { info: 'text-secondary', success: 'text-green-400', warning: 'text-orange-400', system: 'text-yellow-400' };
            const logEntry = document.createElement('div');
            const timestamp = new Date(log.timestamp).toLocaleTimeString('ko-KR', { hour12: false });
            logEntry.innerHTML = `<span class="font-mono text-gray-500">[${timestamp}]</span> <span class="${colors[log.type] || 'text-secondary'}">${log.message}</span>`;
            dom.eventLog.appendChild(logEntry);
        });
        dom.eventLog.scrollTop = dom.eventLog.scrollHeight;
    }

    function addLog(message, type = 'info') {
        raidState.logs.push({ timestamp: new Date().toISOString(), message, type });
        renderLogs(raidState.logs);
    }

    function handleStartRaid() {
        soundManager.play('start');
        raidState.state = 'running';
        raidState.raidStartedAt = Date.now();
        addLog('ë ˆì´ë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'system');
        if (raidState.isAutoDeathMode) {
            addLog('5ì´ˆ í›„, ì‚¬ë§ì íƒ€ì´ë¨¸ê°€ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤.', 'info');
            autoDeathTimeoutId = setTimeout(handleDeath, 5000);
        } else {
            addLog('ìˆ˜ë™ ëª¨ë“œì…ë‹ˆë‹¤. ì‚¬ë§ì ë°œìƒ ì‹œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'info');
        }
        render(raidState);
    }

    function handleDeath() {
        soundManager.play('death');
        if (autoDeathTimeoutId) clearTimeout(autoDeathTimeoutId);
        raidState.state = 'res-active';
        const now = Date.now();
        raidState.resurrectionActiveUntil = now + RES_DURATION * 1000;
        const recommendedTime = new Date(now + IDEAL_CYCLE_TIME * 1000);
        raidState.resScheduleTimes = [
            recommendedTime.getTime(),
            recommendedTime.getTime() + IDEAL_CYCLE_TIME * 1000,
            recommendedTime.getTime() + IDEAL_CYCLE_TIME * 2 * 1000
        ];
        addLog('ì‚¬ë§ì ë°œìƒ. ë¦¬ì € íƒ€ì´ë¨¸ ì‹œì‘.', 'warning');
        render(raidState);
    }

    function handleUseResurrection() {
        if (raidState.bishops.length === 0) return;
        const now = Date.now();
        const bishop = raidState.bishops[raidState.currentBishopIndex];
        if (bishop.cooldownEndsAt && bishop.cooldownEndsAt > now) return;
        soundManager.play('res-used');
        addLog(`${bishop.name}ë‹˜ì´ ë¦¬ì €ë ‰ì…˜ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`, 'success');
        raidState.state = 'running';
        raidState.resurrectionActiveUntil = null;
        raidState.resScheduleTimes = [];
        bishop.resCount++;
        bishop.cooldownEndsAt = now + BISHOP_COOLDOWN * 1000;
        bishop.usedAt = now;
        raidState.currentBishopIndex = (raidState.currentBishopIndex + 1) % raidState.bishops.length;
        if (raidState.isAutoDeathMode) {
            addLog('3ì´ˆ í›„, ë‹¤ìŒ ì‚¬ë§ì íƒ€ì´ë¨¸ê°€ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤.', 'info');
            autoDeathTimeoutId = setTimeout(handleDeath, 3000);
        } else {
            addLog('ìˆ˜ë™ ëª¨ë“œì…ë‹ˆë‹¤. ì‚¬ë§ì ë°œìƒ ì‹œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'info');
        }
        render(raidState);
    }
    
    function handleReset() {
        if (confirm("ì •ë§ë¡œ ëª¨ë“  ì§„í–‰ ìƒí™©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            if (autoDeathTimeoutId) clearTimeout(autoDeathTimeoutId);
            if (timerInterval) clearInterval(timerInterval);
            raidState = getInitialState();
            addLog('ë ˆì´ë“œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'system');
            render(raidState);
        }
    }

    function handleEndRaid() {
        if (timerInterval) clearInterval(timerInterval);
        if (autoDeathTimeoutId) clearTimeout(autoDeathTimeoutId);
        raidState.state = 'ended';
        addLog('ë ˆì´ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ ìš”ì•½ì„ í‘œì‹œí•©ë‹ˆë‹¤.', 'system');
        const finalSeconds = raidState.raidStartedAt ? Math.floor((Date.now() - raidState.raidStartedAt) / 1000) : 0;
        raidState.totalSeconds = finalSeconds;
        const bishopSummaryHtml = raidState.bishops.map(b => `<p><strong>${b.name}:</strong> ë¦¬ì €ë ‰ì…˜ ${b.resCount}íšŒ ì‚¬ìš©</p>`).join('');
        const totalDeaths = raidState.logs.filter(log => log.type === 'warning').length;
        dom.summaryContent.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h4 class="text-3xl font-bold text-yellow-400">ë ˆì´ë“œ ê²°ê³¼ ìš”ì•½</h4>
                <button id="copySummaryBtn" class="btn p-2">ê°„í¸ ìš”ì•½ ë³µì‚¬</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-black/20 p-4 rounded-lg">
                    <h5 class="text-xl font-bold text-yellow-400 mb-2">ì¢…í•© ì •ë³´</h5>
                    <p><strong>ì´ ë ˆì´ë“œ ì‹œê°„:</strong> ${formatTime(finalSeconds)}</p>
                    <p><strong>ì‹œì‘ ì‹œê°:</strong> ${formatClockTime(new Date(raidState.raidStartedAt))}</p>
                    <p><strong>ì¢…ë£Œ ì‹œê°:</strong> ${formatClockTime(new Date())}</p>
                    <p><strong>ì´ ì‚¬ë§ íšŸìˆ˜:</strong> ${totalDeaths}íšŒ</p>
                </div>
                <div class="bg-black/20 p-4 rounded-lg">
                    <h5 class="text-xl font-bold text-yellow-400 mb-2">íŒŒí‹°ì›ë³„ ë¦¬ì €ë ‰ì…˜ ì‚¬ìš© íšŸìˆ˜</h5>
                    ${bishopSummaryHtml || '<p>ë¦¬ì €ë ‰ì…˜ ì‚¬ìš© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                </div>
            </div>`;
        dom.summaryContainer.classList.add('expanded');
        document.getElementById('copySummaryBtn')?.addEventListener('click', () => {
            const bishopResText = raidState.bishops.map(b => `${b.name}: ${b.resCount}íšŒ`).join(' / ');
            const textToCopy = `ì´ ì‹œê°„: ${formatTime(finalSeconds, false)}, ì´ ë°ì¹´: ${totalDeaths}íšŒ / ${bishopResText}`;
            navigator.clipboard.writeText(textToCopy).then(() => alert('ê°„í¸ ìš”ì•½ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
        });
        render(raidState);
    }
    
    function updateBishopName(index, newName) {
        if (!newName || !raidState.bishops[index]) { render(raidState); return; };
        const oldName = raidState.bishops[index].name;
        raidState.bishops[index].name = newName;
        addLog(`'${oldName}' -> '${newName}' ì´ë¦„ ë³€ê²½.`, 'info');
        renderControlPanel(raidState);
    }
    
    function addBishop() {
        if (raidState.state !== 'initial') return;
        const newBishopName = `ë¹„ìˆ${raidState.bishops.length + 1}`;
        raidState.bishops.push({ name: newBishopName, cooldownEndsAt: null, usedAt: null, resCount: 0 });
        addLog(`${newBishopName}ì´(ê°€) íŒŒí‹°ì— ì°¸ê°€í–ˆìŠµë‹ˆë‹¤.`, 'info');
        render(raidState);
    }

    function removeBishop(index) {
        if (raidState.state !== 'initial' || !raidState.bishops[index]) return;
        const removedBishop = raidState.bishops.splice(index, 1)[0];
        addLog(`${removedBishop.name}ì´(ê°€) íŒŒí‹°ì—ì„œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
        if (raidState.currentBishopIndex >= raidState.bishops.length) {
            raidState.currentBishopIndex = 0;
        }
        render(raidState);
    }

    function formatTime(s, showSeconds = true) {
        if (s <= 0 || isNaN(s)) return showSeconds ? '00:00:00' : '00:00';
        const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = Math.floor(s % 60);
        return showSeconds ? `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}` : `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }
    function formatClockTime(date) { return date.toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }); }
    function updateKstClock() { dom.kstTime.textContent = formatClockTime(new Date()); }

    function updateAutoDeathModeUI(isAuto) {
        dom.autoModeLabel.classList.toggle('text-yellow-400', isAuto);
        dom.manualModeLabel.classList.toggle('text-yellow-400', !isAuto);
    }

    function attachEventListeners() {
        dom.resetBtn.addEventListener('click', handleReset);
        dom.endRaidBtn.addEventListener('click', handleEndRaid);
        dom.muteBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            dom.muteBtn.innerHTML = isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-high"></i>';
        });
        
        dom.resTimesDisplay.addEventListener('click', () => {
            if (raidState.resScheduleTimes?.length > 0) {
                const minutes = raidState.resScheduleTimes.map(ts => new Date(ts).getMinutes());
                const textToCopy = `${minutes.join(', ')} ë¦¬ì €`;
                navigator.clipboard.writeText(textToCopy).then(() => alert(`'${textToCopy}'ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`));
            }
        });
        
        dom.controlPanel.addEventListener('click', (e) => {
            const targetId = e.target.id || e.target.closest('button')?.id;
            if (targetId === 'startRaidBtn') handleStartRaid();
            if (targetId === 'deathBtn') handleDeath();
            if (targetId === 'useResBtn') handleUseResurrection();
        });

        dom.addBishopBtn.addEventListener('click', addBishop);

        dom.bishopList.addEventListener('click', e => {
            if (e.target.classList.contains('remove-bishop-btn')) {
                removeBishop(parseInt(e.target.dataset.index));
            }
        });
        dom.bishopList.addEventListener('blur', e => {
            if (e.target.classList.contains('bishop-name')) {
                updateBishopName(parseInt(e.target.dataset.index), e.target.textContent.trim());
            }
        }, true);
        dom.bishopList.addEventListener('keydown', e => {
            if (e.target.classList.contains('bishop-name') && e.key === 'Enter') {
                e.preventDefault(); e.target.blur();
            }
        });
        
        dom.autoDeathToggle.addEventListener('change', (e) => {
            raidState.isAutoDeathMode = e.target.checked;
            updateAutoDeathModeUI(raidState.isAutoDeathMode);
            const mode = raidState.isAutoDeathMode ? 'ìë™' : 'ìˆ˜ë™';
            addLog(`: ${mode} ëª¨ë“œ`, 'system');
            localStorage.setItem('raidChronicle_autoDeathMode', raidState.isAutoDeathMode);
        });
    }
    
    // --- ì•± ì‹œì‘ ---
    init();
});
</script>
</body>
</html>
